<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>asyncio &mdash; Krystal Python 0.post1+g6a351e1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Future" href="future.html" />
    <link rel="prev" title="Generator, yield and yield from" href="generator.html" />
 
<script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-185617644-1']);
  _gaq.push(['_trackPageview']);
</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ff8fbe" >
            <a href="index.html" class="icon icon-home"> Krystal Python
          </a>
              <div class="version">
                0.post1+g6a351e1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Philosophy of this Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="annotation.html">Typing and annotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="assert.html">assert</a></li>
<li class="toctree-l1"><a class="reference internal" href="lambda.html">lambda</a></li>
<li class="toctree-l1"><a class="reference internal" href="dunder.html">Dunder methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparision.html">Chaining Comparison Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="zip.html">zip</a></li>
<li class="toctree-l1"><a class="reference internal" href="comprehension.html">Comprehension</a></li>
<li class="toctree-l1"><a class="reference internal" href="variables.html">Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="walrus.html">Walrus operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="copy.html">Deepcopy vs Shallow copy</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutabledefault.html">Mutable default arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="dirvsdict.html">dir vs __dict__</a></li>
<li class="toctree-l1"><a class="reference internal" href="forelse.html">for else</a></li>
<li class="toctree-l1"><a class="reference internal" href="import.html">import</a></li>
<li class="toctree-l1"><a class="reference internal" href="scope.html">Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="starred.html">Starred expression</a></li>
<li class="toctree-l1"><a class="reference internal" href="try.html">try, except, else and finally</a></li>
<li class="toctree-l1"><a class="reference internal" href="iter.html">iter</a></li>
<li class="toctree-l1"><a class="reference internal" href="itertools.html">itertools</a></li>
<li class="toctree-l1"><a class="reference internal" href="map_filter_reduce.html">Map, Filter and Reduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="container.html">High performance container</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorator.html">Decorator</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataclass.html">Case Study: dataclass</a></li>
<li class="toctree-l1"><a class="reference internal" href="decoratormethod.html">A decorator as class method</a></li>
<li class="toctree-l1"><a class="reference internal" href="descriptor.html">Descriptor</a></li>
<li class="toctree-l1"><a class="reference internal" href="classmethod.html">classmethod, staticmethod and property</a></li>
<li class="toctree-l1"><a class="reference internal" href="functools.html">functools</a></li>
<li class="toctree-l1"><a class="reference internal" href="newvsinit.html">new vs  init</a></li>
<li class="toctree-l1"><a class="reference internal" href="super.html">super</a></li>
<li class="toctree-l1"><a class="reference internal" href="meta.html">Metaclass</a></li>
<li class="toctree-l1"><a class="reference internal" href="singleton.html">Singleton</a></li>
<li class="toctree-l1"><a class="reference internal" href="abstractmethod.html">Abstractmethod</a></li>
<li class="toctree-l1"><a class="reference internal" href="threading.html">Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing.html">Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="generator.html">Generator, yield and yield from</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">asyncio</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-asyncio">What is asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-is-coroutine">What is coroutine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-run-coroutine-concurrently">How to run coroutine concurrently</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-minimum-example">A minimum example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-reason-of-concurrently">The reason of concurrently</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-we-need-await">Why we need await</a></li>
<li class="toctree-l2"><a class="reference internal" href="#when-you-use-asyncio">When you use asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-pattern">Design Pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="future.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="concurrentfuture.html">Processing async vs concurrent.future</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytest.html">pytest with contest and parameterize</a></li>
<li class="toctree-l1"><a class="reference internal" href="pdb.html">Debugging by pdb</a></li>
<li class="toctree-l1"><a class="reference internal" href="searchmethod.html">Search methods’ host class</a></li>
<li class="toctree-l1"><a class="reference internal" href="inspect.html">Inspect function caller</a></li>
<li class="toctree-l1"><a class="reference internal" href="setuptools.html">setuptools</a></li>
<li class="toctree-l1"><a class="reference internal" href="conda.html">Conda Virtual Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="argparse.html">argparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="vscode.html">vscode</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythontutor.html">pythontutor</a></li>
<li class="toctree-l1"><a class="reference internal" href="rst.html">RST</a></li>
<li class="toctree-l1"><a class="reference internal" href="ambush.html">ambush</a></li>
<li class="toctree-l1"><a class="reference internal" href="cython.html">cython101</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_plus_python.html">Use C++ function/class in python</a></li>
<li class="toctree-l1"><a class="reference internal" href="github_actions.html">Github Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="wheel.html">Buiding Package: What, Why and How</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ff8fbe" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Krystal Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>asyncio</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/asyncio.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="asyncio">
<h1>asyncio<a class="headerlink" href="#asyncio" title="Permalink to this heading">¶</a></h1>
<section id="what-is-asyncio">
<h2>What is asyncio<a class="headerlink" href="#what-is-asyncio" title="Permalink to this heading">¶</a></h2>
<p>Async is simply not-sync. Synchronous means in order. So asynchronous menas not in order.
A synchronous programme logic is as simple as function: Enter it, run it then return it. From outside view of function, functions runs one by one. You need wait one finished to start another one. The previous function block running.
Well async allow you run multiple coroutine(name for async function) concurrently.</p>
</section>
<section id="what-is-coroutine">
<h2>What is coroutine<a class="headerlink" href="#what-is-coroutine" title="Permalink to this heading">¶</a></h2>
<p>Just define function by <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code>. Then we call it a coroutine.</p>
</section>
<section id="how-to-run-coroutine-concurrently">
<h2>How to run coroutine concurrently<a class="headerlink" href="#how-to-run-coroutine-concurrently" title="Permalink to this heading">¶</a></h2>
<p>By using <code class="docutils literal notranslate"><span class="pre">asyncio.gather</span></code>, coroutines are running concurrently.</p>
</section>
<section id="a-minimum-example">
<h2>A minimum example<a class="headerlink" href="#a-minimum-example" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One&quot;</span><span class="p">)</span>
  <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Two&quot;</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">worker</span><span class="p">(),</span> <span class="n">worker</span><span class="p">(),</span> <span class="n">worker</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
<span class="n">One</span>
<span class="n">One</span>
<span class="n">One</span>
<span class="n">Two</span>
<span class="n">Two</span>
<span class="n">Two</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">In code above, worker is a <strong>coroutine</strong>.</div>
<div class="line">A <strong>coroutine</strong> is a function that can suspend its execution before reaching return, and it can indirectly pass control to another coroutine for some time. My understanding of <strong>corountine</strong> is function defined by <code class="docutils literal notranslate"><span class="pre">async</span></code> and use <code class="docutils literal notranslate"><span class="pre">await</span></code> inside.</div>
</div>
<p>The keyword <code class="docutils literal notranslate"><span class="pre">await</span></code> passes function control back to the event loop. (It suspends the execution of the surrounding coroutine. In above example, <code class="docutils literal notranslate"><span class="pre">await</span></code> suspends <code class="docutils literal notranslate"><span class="pre">worker</span></code> until <code class="docutils literal notranslate"><span class="pre">asyncio.sleep(1)</span></code> returned. In the meantime, go let something else run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">awaitable</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">aws</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Run awaitable objects in the <code class="docutils literal notranslate"><span class="pre">aws</span></code> sequence concurrently.</p></li>
<li><p>If any awaitable in <code class="docutils literal notranslate"><span class="pre">aws</span></code> is a coroutine, it is automatically scheduled as a Task.</p></li>
<li><p>If all awaitables are completed successfully, the result is an aggregate <strong>list</strong> of returned values. The order of result values corresponds to the order of awaitables in <code class="docutils literal notranslate"><span class="pre">aws</span></code>.</p></li>
</ul>
</section>
<section id="the-reason-of-concurrently">
<h2>The reason of concurrently<a class="headerlink" href="#the-reason-of-concurrently" title="Permalink to this heading">¶</a></h2>
<p>Why coroutine ran concurrently, there are two concepts, task and future.</p>
<p>Task is a bad name. When coroutine become a task, it actually already start running. This is usually being done by <code class="docutils literal notranslate"><span class="pre">create_task</span></code>.</p>
</section>
<section id="why-we-need-await">
<h2>Why we need await<a class="headerlink" href="#why-we-need-await" title="Permalink to this heading">¶</a></h2>
<p>A example without await</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">say_after</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="s1">&#39;Start say_after(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delay</span><span class="p">,</span><span class="n">what</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="n">what</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="s1">&#39;Before creating tasks.&#39;</span><span class="p">)</span>
    <span class="n">task1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">say_after</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">))</span>
    <span class="n">task2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">say_after</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">task1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">task1</span><span class="p">)</span>
    <span class="c1"># await task1</span>
    <span class="c1"># await task2</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total time elapsed: </span><span class="si">%.2f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1612200605.1537979 Before creating tasks.
&lt;Task pending name=&#39;Task-2&#39; coro=&lt;say_after() running at m.py:4&gt;&gt;
&lt;Task pending name=&#39;Task-2&#39; coro=&lt;say_after() running at m.py:4&gt;&gt;
Total time elapsed: 0.00 seconds
1612200605.153934 Start say_after(1, hello)
1612200605.1539571 Start say_after(2, world)
</pre></div>
</div>
</section>
<section id="when-you-use-asyncio">
<h2>When you use asyncio<a class="headerlink" href="#when-you-use-asyncio" title="Permalink to this heading">¶</a></h2>
<p>Solutions choice of CPU bound and IO bound problem.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 28%" />
<col style="width: 45%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><div class="line-block">
<div class="line">preemptive multitasking</div>
<div class="line">aka multi-threading</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">event driven cooperative multitasking,</div>
<div class="line">asyncio(single thread, single process)</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">multiprocess</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CPU Bound</p></td>
<td><p>not good</p></td>
<td><p>not good</p></td>
<td><p>best</p></td>
</tr>
<tr class="row-odd"><td><p>IO Bound</p></td>
<td><div class="line-block">
<div class="line">Ok if some event refuse</div>
<div class="line">to release event loop</div>
</div>
</td>
<td><p>Best</p></td>
<td><p>not good</p></td>
</tr>
</tbody>
</table>
</section>
<section id="design-pattern">
<h2>Design Pattern<a class="headerlink" href="#design-pattern" title="Permalink to this heading">¶</a></h2>
<p>Running Tasks Concurrently</p>
<p>#1</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">func</span><span class="p">()</span>
  <span class="k">await</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>#2
Most important part:
When a coroutine is wrapped into a Task with functions like asyncio.create_task() the coroutine is automatically scheduled to run immediately.
Coroutine start to run immedietely by <code class="docutils literal notranslate"><span class="pre">create_task</span></code> and <code class="docutils literal notranslate"><span class="pre">await</span></code> make it hand control back to loop.
So <code class="docutils literal notranslate"><span class="pre">Task</span></code> is neither a object or a status but a RUNNING stuff. When you create it, it start running immediately.</p>
<p><code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">container</span></code> is actually wait. container(a future-like obj) is waiting to be filled. You could use container.result() to check coroutine’s return.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">func</span><span class="p">()</span>
  <span class="k">await</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">task1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">func</span><span class="p">())</span>
  <span class="n">task2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">func</span><span class="p">())</span>
  <span class="k">await</span> <span class="n">task1</span>
  <span class="k">await</span> <span class="n">task2</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Notice:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">say_after</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;started at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%X</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">task1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">say_after</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">task1</span>
    <span class="n">task2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">say_after</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">task2</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finished at </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%X</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>Why its need 3 seconds to finish above code:
After <code class="docutils literal notranslate"><span class="pre">task1</span></code> by <code class="docutils literal notranslate"><span class="pre">create_task</span></code>, we are await task1(future-like obj) to be materilized. task2 still not in loop’s scope. So even task1 return control back to loop, loop doesn’t realize task2. It’s actually running in a synchronous way.</p>
<p>Notice:</p>
<p>If a task starts, does it guarantee it ends in expected time? No!</p>
<p>Let’s see this example below.</p>
<dl class="simple">
<dt>async def main():</dt><dd><p>start_time = time.time()
print(start_time, ‘Before creating tasks.’)
task1 = asyncio.create_task(say_after(1, ‘hello’))
task2 = asyncio.create_task(say_after(2, ‘world’))
print(time.time(),”Before delay - after creating tasks”)
await asyncio.sleep(0.1)
time.sleep(3) ##  DELAY ##
print(time.time(),”After delay - before await tasks”)
await task1
await task2
end_time = time.time()
print(‘Total time elapsed: %.2f seconds’ % (end_time - start_time))</p>
</dd>
</dl>
<p>Here <code class="docutils literal notranslate"><span class="pre">loop</span></code> is in the same process with <code class="docutils literal notranslate"><span class="pre">time.sleep(3)</span></code>. So loop is block for 3 seconds. When loop is resumed, it found task1 and task2(both future-like objs) are already filled, so it immediately continue.</p>
<p>We have asyncio.sleep(0.1) in line #7 to allow task1 and task2 to start, but add time.sleep(3) in line #8 to block for 3 seconds afterwards.
Here is the output:</p>
<p>You see both tasks start immediately in line #3 and #4, but do not ‘say’ after the expected 1 seconds or 2 seconds, instead ‘say’ (end) after 3 seconds.
The reason is that when say_after is awaiting for 1 / 2 seconds, the event loop goes back to main task and blocks there for 3 seconds before it can loop back to say_after tasks to continue.</p>
<p>To achieve good concurrency through coroutines, any code called within asyncio.run must be written in a non-blocking way. In practice, it means that any code run within a task has the responsibility to signal when it is a good time to pause execution, e.g. “I’m not doing anything useful because I’m waiting on I/O…” - this is allowing another task to use the event loop.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="generator.html" class="btn btn-neutral float-left" title="Generator, yield and yield from" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="future.html" class="btn btn-neutral float-right" title="Future" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Ke Zhang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<div class="footer">This page uses <a href="https://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script>
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>


</body>
</html>